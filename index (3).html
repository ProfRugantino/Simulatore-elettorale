<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elezioni parlamentari nazionali italiane 1861–2022</title>
  <!-- Chart.js CDN for interactive pie charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Palette di colori principali */
      --primary-color: #004d88;
      --secondary-color: #c44536;
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #333333;
      --highlight-color: #e0f3ff;
      --modeA-color1: #457b9d;
      --modeA-color2: #a8dadc;
      --modeB-color1: #2a9d8f;
      --modeB-color2: #e9c46a;
      --modeC-color1: #264653;
      --modeC-color2: #e9c46a;
      --modeC-color3: #e76f51;
      --disabled-color: #cccccc;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.4;
    }
    header {
      background-color: var(--primary-color);
      color: #ffffff;
      padding: 1.5rem 2rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    header p {
      margin: .2rem 0 0 0;
      font-size: 1rem;
      opacity: 0.9;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem 2rem;
      background-color: var(--card-bg);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border-bottom: 1px solid #e0e0e0;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      min-width: 160px;
    }
    .control-group label {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    .control-group select,
    .control-group input[type="range"],
    .control-group input[type="text"] {
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .control-group input[type="range"] {
      width: 100%;
    }
    .control-group input[type="text"] {
      min-width: 200px;
    }
    .toggle-group {
      display: flex;
      align-items: center;
    }
    .toggle-group label {
      margin-right: 0.5rem;
      font-weight: bold;
    }
    .toggle-group select {
      padding: 0.3rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem 2rem;
    }
    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      flex: 1 1 300px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.4rem;
      color: var(--primary-color);
    }
    .card .field {
      margin-bottom: 0.5rem;
    }
    .card .field strong {
      display: inline-block;
      width: 140px;
    }
    .chart-container {
      flex: 1 1 300px;
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      position: relative;
      /* altezza minima per garantire spazio al grafico */
      min-height: 360px;
    }
    .chart-container h3 {
      margin-top: 0;
      font-size: 1.4rem;
      color: var(--primary-color);
    }
    .table-container {
      padding: 1rem 2rem;
    }

    /* Forza dimensioni del canvas Chart.js per assicurare visibilità */
    .chart-container canvas {
      width: 100% !important;
      height: 300px !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    thead {
      background-color: var(--primary-color);
      color: #ffffff;
    }
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
    }
    th.sortable {
      cursor: pointer;
    }
    th.sortable:hover {
      background-color: var(--secondary-color);
    }
    tbody tr:hover {
      background-color: #f0f8ff;
    }
    tbody tr.selected {
      background-color: var(--highlight-color);
    }
    #quality-log {
      margin-top: 1rem;
      padding: 1rem;
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    #quality-log h3 {
      margin-top: 0;
      font-size: 1.2rem;
      color: var(--primary-color);
    }
    #quality-log p {
      margin: 0.2rem 0;
      font-size: 0.9rem;
    }
    @media (max-width: 768px) {
      .card .field strong {
        width: 100px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Elezioni parlamentari nazionali italiane</h1>
    <p>Corpo elettorale, popolazione e sistemi (1861–2022)</p>
  </header>
  <!-- Controls for filtering and selection -->
  <div class="controls">
    <div class="control-group">
      <label for="year-select">Seleziona anno</label>
      <select id="year-select"></select>
    </div>
    <div class="control-group">
      <label for="year-slider">Scorri anno</label>
      <input type="range" id="year-slider" min="0" max="0" step="1" value="0">
    </div>
    <div class="control-group">
      <label for="istituzione-filter">Filtra istituzione</label>
      <select id="istituzione-filter">
        <option value="tutti">Tutte</option>
        <option value="regno">Regno</option>
        <option value="costituente">Costituente</option>
        <option value="repubblica">Repubblica</option>
      </select>
    </div>
    <div class="control-group">
      <label for="search-input">Ricerca (sistema/legge)</label>
      <input type="text" id="search-input" placeholder="Cerca...">
    </div>
    <div class="control-group toggle-group">
      <label for="mode-select">Modalità torta</label>
      <select id="mode-select">
        <option value="A">Aventi vs non aventi</option>
        <option value="B">Votanti stimati vs non votanti</option>
        <option value="C">Votanti/non votanti/non aventi</option>
      </select>
    </div>
  </div>
  <div class="main-content">
    <div class="card" id="election-card">
      <h2 id="card-title">Seleziona un anno</h2>
      <div class="field"><strong>Anno:</strong> <span id="field-anno">—</span></div>
      <div class="field"><strong>Istituzione:</strong> <span id="field-istituzione">—</span></div>
      <div class="field"><strong>Sistema elettorale:</strong> <span id="field-sistema">—</span></div>
      <div class="field"><strong>Legge:</strong> <span id="field-legge">—</span></div>
      <div class="field"><strong>Descrizione:</strong> <span id="field-descrizione">—</span></div>
      <div class="field"><strong>Popolazione:</strong> <span id="field-popolazione">—</span></div>
      <div class="field"><strong>Aventi diritto:</strong> <span id="field-aventi">—</span></div>
      <div class="field"><strong>% aventi diritto:</strong> <span id="field-perc">—</span></div>
      <div class="field"><strong>Affluenza:</strong> <span id="field-affluenza">—</span></div>
    </div>
    <div class="chart-container">
      <h3 id="chart-title">Grafico a torta</h3>
      <canvas id="pie-chart" width="400" height="400"></canvas>
      <div id="mode-warning" style="color: var(--secondary-color); margin-top: 0.5rem; display:none; font-size:0.85rem;"></div>
    </div>
  </div>
  <div class="table-container">
    <table id="data-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="anno">Anno</th>
          <th>Tipo di istituzione</th>
          <th>Popolazione</th>
          <th>Aventi diritto</th>
          <th>% aventi diritto</th>
          <th>Affluenza</th>
          <th>Sistema</th>
          <th>Legge</th>
          <th>Descrizione</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="quality-log">
    <h3>Log qualità dati</h3>
    <!-- Il contenuto del log verrà popolato via JS -->
  </div>
<script>
// === Inizio dati in formato Markdown ===
const markdownTable = `|   Anno | Tipo di istituzione                       | Popolazione totale                                                                   | Aventi diritto   | % popolazione avente diritto   | Affluenza %   | Sistema elettorale                                     | Legge elettorale                                                     | Descrizione tecnica (≤20 parole)                                                                 |
|-------:|:------------------------------------------|:------------------------------------------------------------------------------------|:----------------|:-------------------------------|:--------------|:-------------------------------------------------------|:---------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------|
|   1861 | Regno d’Italia – Camera dei deputati      | 22.176.000 (Istat, Tav. 2.1.1 (cens. 31/12/1861; confini dell’epoca))                | 418.696         | 1,9                            | 57,2          | Suffragio censitario uninominale                       | Legge elettorale 1861 (derivazione subalpina 1848/1860)              | Collegi uninominali maggioritari; doppio turno; elettorato maschile ristretto per censo e istruzione. |
|   1865 | Regno d’Italia – Camera dei deputati      | 22.689.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 504.263         | 2,2                            | 53,9          | Suffragio censitario uninominale                       | Legge elettorale 1861 (derivazione subalpina 1848/1860)              | Collegi uninominali maggioritari; doppio turno; elettorato maschile ristretto per censo e istruzione. |
|   1867 | Regno d’Italia – Camera dei deputati      | 25.772.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 498.208         | 1,9                            | 51,8          | Suffragio censitario uninominale                       | Legge elettorale 1861 (derivazione subalpina 1848/1860)              | Collegi uninominali maggioritari; doppio turno; elettorato maschile ristretto per censo e istruzione. |
|   1870 | Regno d’Italia – Camera dei deputati      | 26.177.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 530.018         | 2,0                            | 45,5          | Suffragio censitario uninominale                       | Legge elettorale 1861 (derivazione subalpina 1848/1860)              | Collegi uninominali maggioritari; doppio turno; elettorato maschile ristretto per censo e istruzione. |
|   1874 | Regno d’Italia – Camera dei deputati      | 27.612.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 571.939         | 2,1                            | 55,7          | Suffragio censitario uninominale                       | Legge elettorale 1861 (derivazione subalpina 1848/1860)              | Collegi uninominali maggioritari; doppio turno; elettorato maschile ristretto per censo e istruzione. |
|   1876 | Regno d’Italia – Camera dei deputati      | 28.037.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 605.007         | 2,2                            | 60,2          | Suffragio censitario uninominale                       | Legge elettorale 1861 (derivazione subalpina 1848/1860)              | Collegi uninominali maggioritari; doppio turno; elettorato maschile ristretto per censo e istruzione. |
|   1880 | Regno d’Italia – Camera dei deputati      | 28.670.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 621.896         | 2,2                            | 57,0          | Suffragio censitario uninominale                       | Legge elettorale 1861 (derivazione subalpina 1848/1860)              | Collegi uninominali maggioritari; doppio turno; elettorato maschile ristretto per censo e istruzione. |
|   1882 | Regno d’Italia – Camera dei deputati      | 28.953.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.112.563       | 7,3                            | 56,2          | Suffragio allargato con scrutinio di lista maggioritario | Riforma elettorale 1882                                              | Collegi plurinominali; voto limitato; esito maggioritario; criteri d’accesso ampliati ma non universali. |
|   1886 | Regno d’Italia – Camera dei deputati      | 29.939.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.480.897       | 8,3                            | 54,1          | Suffragio allargato con scrutinio di lista maggioritario | Riforma elettorale 1882                                              | Collegi plurinominali; voto limitato; esito maggioritario; criteri d’accesso ampliati ma non universali. |
|   1890 | Regno d’Italia – Camera dei deputati      | 30.775.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.826.055       | 9,2                            | 58,8          | Suffragio allargato con scrutinio di lista maggioritario | Riforma elettorale 1882                                              | Collegi plurinominali; voto limitato; esito maggioritario; criteri d’accesso ampliati ma non universali. |
|   1892 | Regno d’Italia – Camera dei deputati      | 31.161.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 3.006.345       | 9,6                            | 58,9          | Suffragio allargato con collegi uninominali maggioritari | Legge 1882 (suffragio) e riforme corr. (collegi uninominali)         | Collegi uninominali; maggioritario a doppio turno; elettorato maschile ampliato (criteri censitari/capacità). |
|   1895 | Regno d’Italia – Camera dei deputati      | 31.782.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.159.214       | 6,8                            | 57,6          | Suffragio allargato con collegi uninominali maggioritari | Legge 1882 (suffragio) e riforme corr. (collegi uninominali)         | Collegi uninominali; maggioritario a doppio turno; elettorato maschile ampliato (criteri censitari/capacità). |
|   1897 | Regno d’Italia – Camera dei deputati      | 32.135.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.152.909       | 6,7                            | 58,0          | Suffragio allargato con collegi uninominali maggioritari | Legge 1882 (suffragio) e riforme corr. (collegi uninominali)         | Collegi uninominali; maggioritario a doppio turno; elettorato maschile ampliato (criteri censitari/capacità). |
|   1900 | Regno d’Italia – Camera dei deputati      | 32.713.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.272.509       | 6,9                            | 58,3          | Suffragio allargato con collegi uninominali maggioritari | Legge 1882 (suffragio) e riforme corr. (collegi uninominali)         | Collegi uninominali; maggioritario a doppio turno; elettorato maschile ampliato (criteri censitari/capacità). |
|   1904 | Regno d’Italia – Camera dei deputati      | 33.584.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.560.327       | 7,6                            | 63,3          | Suffragio allargato con collegi uninominali maggioritari | Legge 1882 (suffragio) e riforme corr. (collegi uninominali)         | Collegi uninominali; maggioritario a doppio turno; elettorato maschile ampliato (criteri censitari/capacità). |
|   1909 | Regno d’Italia – Camera dei deputati      | 34.648.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 2.974.473       | 8,6                            | 58,0          | Suffragio allargato con collegi uninominali maggioritari | Legge 1882 (suffragio) e riforme corr. (collegi uninominali)         | Collegi uninominali; maggioritario a doppio turno; elettorato maschile ampliato (criteri censitari/capacità). |
|   1913 | Regno d’Italia – Camera dei deputati      | 36.155.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 8.644.699       | 23,9                           | 60,4          | Suffragio universale maschile con collegi uninominali maggioritari | Riforma elettorale 1912 (Giolitti)                                  | Quasi universale maschile; collegi uninominali; maggioritario; eventuale ballottaggio.              |
|   1919 | Regno d’Italia – Camera dei deputati      | 36.134.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 11.119.271      | 30,8                           | 56,6          | Proporzionale a liste concorrenti                        | Legge proporzionale 1919                                              | Circoscrizioni plurinominali; riparto proporzionale; liste e preferenze; nessun premio di maggioranza. |
|   1921 | Regno d’Italia – Camera dei deputati      | 36.431.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 11.821.168      | 32,4                           | 58,4          | Proporzionale a liste concorrenti                        | Legge proporzionale 1919                                              | Circoscrizioni plurinominali; riparto proporzionale; liste e preferenze; nessun premio di maggioranza. |
|   1924 | Regno d’Italia – Camera dei deputati      | 39.226.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 12.069.336      | 30,8                           | 63,8          | Premio di maggioranza (Legge Acerbo)                     | Legge Acerbo (l. 18 novembre 1923, n. 2444)                          | Collegio nazionale; premio 2/3 seggi alla lista ≥25% voti; residuo proporzionale.                    |
|   1929 | Regno d’Italia – Camera dei deputati      | 40.950.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 9.682.630       | 23,6                           | 89,9          | Sistema plebiscitario a lista unica                      | Riforma della rappresentanza politica (l. 17 maggio 1928, n. 1019)    | Collegio unico; voto sì/no su lista; maggioranza assoluta; elettorato ristretto; assenza competizione. |
|   1934 | Regno d’Italia – Camera dei deputati      | 42.527.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 10.527.608      | 24,8                           | 96,5          | Sistema plebiscitario a lista unica                      | Riforma della rappresentanza politica (l. 17 maggio 1928, n. 1019)    | Collegio unico; voto sì/no su lista; maggioranza assoluta; elettorato ristretto; assenza competizione. |
|   1946 | Assemblea Costituente                     | 46.179.000 (Istat, Tav. 2.3.1 (pop. 1/1; confini dell’epoca))                        | 28.005.449      | 60,6                           | 89,1          | Proporzionale con suffragio universale maschile e femminile | D.lgs.lgt. 10 marzo 1946, n. 74                                      | Circoscrizioni plurinominali; riparto proporzionale; preferenze; elezione contestuale al referendum istituzionale. |
|   1948 | Repubblica Italiana – Camera dei deputati | 46.210.000 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 29.117.270      | 63,0                           | 92,2          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1953 | Repubblica Italiana – Camera dei deputati | 47.792.100 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 30.272.236      | 63,3                           | 93,8          | Proporzionale con premio di maggioranza condizionato     | L. 31 marzo 1953, n. 148 («legge truffa»)                             | Premio 65% seggi a coalizione >50% voti validi; altrimenti riparto proporzionale ordinario.         |
|   1958 | Repubblica Italiana – Camera dei deputati | 49.312.700 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 32.434.835      | 65,8                           | 93,8          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1963 | Repubblica Italiana – Camera dei deputati | 51.060.100 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 34.199.184      | 67,0                           | 92,9          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1968 | Repubblica Italiana – Camera dei deputati | 53.080.900 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 35.566.493      | 67,0                           | 92,8          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1972 | Repubblica Italiana – Camera dei deputati | 54.978.700 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 37.049.351      | 67,4                           | 93,2          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1976 | Repubblica Italiana – Camera dei deputati | 55.823.700 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 40.426.658      | 72,4                           | 93,4          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1979 | Repubblica Italiana – Camera dei deputati | 56.105.500 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 42.203.354      | 75,2                           | 90,6          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1983 | Repubblica Italiana – Camera dei deputati | 57.016.400 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 44.526.357      | 78,1                           | 88,0          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1987 | Repubblica Italiana – Camera dei deputati | 57.501.700 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 45.692.417      | 79,5                           | 88,8          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1992 | Repubblica Italiana – Camera dei deputati | 56.772.923 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 47.435.689      | 83,6                           | 87,3          | Proporzionale repubblicano                               | Legge 7 ottobre 1947, n. 1058; poi T.U. d.P.R. 30 marzo 1957, n. 361 | Circoscrizioni plurinominali; riparto proporzionale; preferenze multiple; nessun premio di maggioranza. |
|   1994 | Repubblica Italiana – Camera dei deputati | 56.843.000 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 48.235.213      | 84,9                           | 86,1          | Sistema misto (Mattarellum)                             | L. 4 agosto 1993, n. 277                                              | 75% collegi uninominali plurality; 25% proporzionale con scorporo; scheda unica collegata a liste. |
|   1996 | Repubblica Italiana – Camera dei deputati | 56.844.000 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 48.846.238      | 85,9                           | 82,9          | Sistema misto (Mattarellum)                             | L. 4 agosto 1993, n. 277                                              | 75% collegi uninominali plurality; 25% proporzionale con scorporo; scheda unica collegata a liste. |
|   2001 | Repubblica Italiana – Camera dei deputati | 56.960.692 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 49.358.947      | 86,7                           | 81,5          | Sistema misto (Mattarellum)                             | L. 4 agosto 1993, n. 277                                              | 75% collegi uninominali plurality; 25% proporzionale con scorporo; scheda unica collegata a liste. |
|   2006 | Repubblica Italiana – Camera dei deputati | 58.064.214 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 47.098.181      | 81,1                           | 83,6          | Proporzionale con premio di maggioranza (Porcellum)      | L. 21 dicembre 2005, n. 270                                           | Liste bloccate; premio di maggioranza; soglie; riparto proporzionale in circoscrizioni e nazionale. |
|   2008 | Repubblica Italiana – Camera dei deputati | 58.652.875 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 47.142.437      | 80,4                           | 80,5          | Proporzionale con premio di maggioranza (Porcellum)      | L. 21 dicembre 2005, n. 270                                           | Liste bloccate; premio di maggioranza; soglie; riparto proporzionale in circoscrizioni e nazionale. |
|   2013 | Repubblica Italiana – Camera dei deputati | 59.685.227 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 47.005.431      | 78,8                           | 75,2          | Proporzionale con premio di maggioranza (Porcellum)      | L. 21 dicembre 2005, n. 270                                           | Liste bloccate; premio di maggioranza; soglie; riparto proporzionale in circoscrizioni e nazionale. |
|   2018 | Repubblica Italiana – Camera dei deputati | 60.483.973 (Istat, Evoluzione demografica 1861-2018 (pop. 1/1))                      | 46.604.897      | 77,1                           | 72,9          | Sistema misto parallelo (Rosatellum)                     | L. 3 novembre 2017, n. 165                                            | Quota uninominale FPTP e quota proporzionale; liste bloccate; voto unico; coalizioni ammesse. |
|   2022 | Repubblica Italiana – Camera dei deputati | 59.030.133 (Istat, Censimento e dinamica 2022 (pop. 1/1/2022))                       | 46.120.143      | 78,1                           | 63,9          | Sistema misto parallelo (Rosatellum)                     | L. 3 novembre 2017, n. 165                                            | Quota uninominale FPTP e quota proporzionale; liste bloccate; voto unico; coalizioni ammesse. |`;
// === Fine dati Markdown ===

/**
 * Analizza la tabella Markdown e restituisce un array di record.
 * Ogni riga diventa un oggetto con chiavi uguali all’intestazione.
 */
function parseMarkdownTable(mdText) {
  const lines = mdText.trim().split(/\r?\n/);
  if (lines.length < 3) return [];
  // La prima riga contiene le intestazioni tra barre verticali
  const headerLine = lines[0];
  const headerCells = headerLine.split('|').slice(1, -1).map(h => h.trim());
  const data = [];
  for (let i = 2; i < lines.length; i++) {
    let row = lines[i];
    if (!row.includes('|')) continue;
    const cols = row.split('|').slice(1, -1).map(c => c.trim());
    if (cols.length !== headerCells.length) continue;
    const obj = {};
    for (let j = 0; j < headerCells.length; j++) {
      obj[headerCells[j]] = cols[j];
    }
    data.push(obj);
  }
  return data;
}

/**
 * Converte una stringa di numero italiano in numero JavaScript.
 * Gestisce separatori di migliaia (.) e virgola come separatore decimale.
 * Se il valore non è parsabile, restituisce null.
 */
function parseItalianNumber(str) {
  if (!str || typeof str !== 'string') return null;
  // rimuove la parte tra parentesi e oltre
  let cleaned = str.split('(')[0].trim();
  // rimuove spazi
  cleaned = cleaned.replace(/\s+/g, '');
  // mantiene solo cifre, punto e virgola
  cleaned = cleaned.replace(/[^0-9.,-]/g, '');
  if (!cleaned) return null;
  // rimuove i punti (separatore migliaia)
  let withoutDots = cleaned.replace(/\./g, '');
  // sostituisce la virgola con il punto come separatore decimale
  let normalized = withoutDots.replace(',', '.');
  const num = parseFloat(normalized);
  return isNaN(num) ? null : num;
}

/**
 * Format integer numbers using Italian locale (punti come separatori).
 */
function formatItalianInt(n) {
  if (n == null || isNaN(n)) return 'ND';
  return Math.round(n).toLocaleString('it-IT');
}

/**
 * Format percentage values with una cifra decimale e virgola.
 */
function formatItalianPercent(x) {
  if (x == null || isNaN(x)) return 'ND';
  return x.toFixed(1).replace('.', ',') + '%';
}

/**
 * Calcola i valori derivati per un record: non aventi, votanti stimati e non votanti.
 */
function computeDerived(row) {
  const derived = {};
  // non aventi: popolazione - aventi
  if (row.popolazione != null && row.aventi != null) {
    derived.non_aventi = row.popolazione - row.aventi;
  } else {
    derived.non_aventi = null;
  }
  // votanti stimati: aventi * affluenza/100
  if (row.aventi != null && row.affluenza != null) {
    const votanti = Math.round(row.aventi * (row.affluenza / 100));
    derived.votanti = votanti;
    derived.non_votanti = row.aventi - votanti;
  } else {
    derived.votanti = null;
    derived.non_votanti = null;
  }
  return derived;
}

// Parsing della tabella e costruzione del dataset
const rawRecords = parseMarkdownTable(markdownTable);
const dataset = rawRecords.map(row => {
  const anno = parseInt(row['Anno']);
  const istituzione = row['Tipo di istituzione'];
  const popolazione_raw = row['Popolazione totale'];
  const popolazione = parseItalianNumber(popolazione_raw);
  const aventi_raw = row['Aventi diritto'];
  const aventi = parseItalianNumber(aventi_raw);
  const perc_aventi_raw = row['% popolazione avente diritto'];
  const perc_aventi = parseItalianNumber(perc_aventi_raw);
  const affluenza_raw = row['Affluenza %'];
  const affluenza = parseItalianNumber(affluenza_raw);
  const sistema = row['Sistema elettorale'];
  const legge = row['Legge elettorale'];
  const descrizione = row['Descrizione tecnica (≤20 parole)'];
  const derived = computeDerived({popolazione, aventi, affluenza});
  return {
    anno,
    istituzione,
    popolazione_raw,
    popolazione,
    aventi_raw,
    aventi,
    perc_aventi_raw,
    perc_aventi,
    affluenza_raw,
    affluenza,
    sistema,
    legge,
    descrizione,
    non_aventi: derived.non_aventi,
    votanti: derived.votanti,
    non_votanti: derived.non_votanti
  };
});

// Costruzione del log di qualità dati
const qualityLog = [];
dataset.forEach(rec => {
  const parts = [];
  if (rec.popolazione == null) parts.push('popolazione ND'); else parts.push('popolazione parsata OK');
  if (rec.aventi == null) parts.push('aventi_diritto ND'); else parts.push('aventi_diritto OK');
  if (rec.affluenza == null) parts.push('affluenza ND'); else parts.push('affluenza OK');
  if (rec.votanti == null) parts.push('modalità B disabilitata');
  qualityLog.push('Anno ' + rec.anno + ': ' + parts.join('; '));
});

// Stato dell’interfaccia
let sortAsc = true;
let selectedYear = dataset[dataset.length - 1].anno; // anno iniziale: l’ultimo disponibile
let filters = {
  istituzione: 'tutti',
  search: '',
  mode: 'A'
};

// Elementi del DOM
const yearSelect = document.getElementById('year-select');
const yearSlider = document.getElementById('year-slider');
const istituzioneFilter = document.getElementById('istituzione-filter');
const searchInput = document.getElementById('search-input');
const modeSelect = document.getElementById('mode-select');
const tableBody = document.querySelector('#data-table tbody');
const cardTitle = document.getElementById('card-title');
const fieldAnno = document.getElementById('field-anno');
const fieldIstituzione = document.getElementById('field-istituzione');
const fieldSistema = document.getElementById('field-sistema');
const fieldLegge = document.getElementById('field-legge');
const fieldDescrizione = document.getElementById('field-descrizione');
const fieldPopolazione = document.getElementById('field-popolazione');
const fieldAventi = document.getElementById('field-aventi');
const fieldPerc = document.getElementById('field-perc');
const fieldAffluenza = document.getElementById('field-affluenza');
const qualityContainer = document.getElementById('quality-log');
const chartTitle = document.getElementById('chart-title');
const modeWarning = document.getElementById('mode-warning');

let pieChart; // riferimento al grafico Chart.js

// Applica i filtri correnti al dataset
function applyFilters() {
  return dataset.filter(row => {
    // filtro istituzione
    if (filters.istituzione && filters.istituzione !== 'tutti') {
      const inst = filters.istituzione;
      // normalizza per confronto: primi termini
      if (inst === 'regno' && !row.istituzione.toLowerCase().startsWith('regno')) return false;
      if (inst === 'costituente' && !row.istituzione.toLowerCase().includes('costituente')) return false;
      if (inst === 'repubblica' && !row.istituzione.toLowerCase().startsWith('repubblica')) return false;
    }
    // filtro di ricerca su sistema o legge
    if (filters.search) {
      const text = (row.sistema + ' ' + row.legge).toLowerCase();
      if (!text.includes(filters.search.toLowerCase())) return false;
    }
    return true;
  });
}

// Aggiorna la dropdown e lo slider degli anni
function updateYearControls(filteredData) {
  // Ordina i dati per anno
  const sorted = filteredData.slice().sort((a,b) => a.anno - b.anno);
  // Aggiorna select
  yearSelect.innerHTML = '';
  sorted.forEach(row => {
    const opt = document.createElement('option');
    opt.value = row.anno;
    opt.textContent = row.anno;
    if (row.anno === selectedYear) opt.selected = true;
    yearSelect.appendChild(opt);
  });
  // Aggiorna slider
  if (sorted.length) {
    yearSlider.min = sorted[0].anno;
    yearSlider.max = sorted[sorted.length - 1].anno;
    yearSlider.value = selectedYear;
    yearSlider.step = 1;
  }
}

// Aggiorna la card e il grafico per l’anno selezionato
function updateCardAndChart() {
  const row = dataset.find(r => r.anno === selectedYear);
  if (!row) return;
  // Aggiorna card
  cardTitle.textContent = 'Scheda elezione ' + row.anno;
  fieldAnno.textContent = row.anno;
  fieldIstituzione.textContent = row.istituzione;
  fieldSistema.textContent = row.sistema;
  fieldLegge.textContent = row.legge;
  fieldDescrizione.textContent = row.descrizione;
  fieldPopolazione.textContent = row.popolazione != null ? formatItalianInt(row.popolazione) : 'ND';
  fieldAventi.textContent = row.aventi != null ? formatItalianInt(row.aventi) : 'ND';
  fieldPerc.textContent = row.perc_aventi != null ? formatItalianPercent(row.perc_aventi) : 'ND';
  fieldAffluenza.textContent = row.affluenza != null ? formatItalianPercent(row.affluenza) : 'ND';
  // Aggiorna grafico
  const mode = filters.mode;
  let data, labels, colors;
  modeWarning.style.display = 'none';
  if (mode === 'A') {
    // Modalità A: aventi vs non aventi
    const aventi = row.aventi;
    const nonAventi = row.non_aventi;
    data = [aventi || 0, nonAventi != null ? nonAventi : 0];
    labels = ['Aventi diritto', 'Non aventi diritto'];
    colors = [getComputedStyle(document.documentElement).getPropertyValue('--modeA-color1'), getComputedStyle(document.documentElement).getPropertyValue('--modeA-color2')];
    chartTitle.textContent = 'Modalità A: Aventi vs non aventi';
  } else if (mode === 'B') {
    // Modalità B: votanti stimati vs non votanti
    if (row.votanti == null || row.non_votanti == null) {
      modeWarning.textContent = 'ND: dati insufficienti per stimare votanti';
      modeWarning.style.display = 'block';
      // ritorna a A se i dati non sono sufficienti
      modeSelect.value = 'A';
      filters.mode = 'A';
      updateCardAndChart();
      return;
    }
    data = [row.votanti, row.non_votanti];
    labels = ['Votanti stimati', 'Non votanti'];
    colors = [getComputedStyle(document.documentElement).getPropertyValue('--modeB-color1'), getComputedStyle(document.documentElement).getPropertyValue('--modeB-color2')];
    chartTitle.textContent = 'Modalità B: Votanti stimati vs non votanti';
  } else {
    // Modalità C: votanti, non votanti e non aventi sul totale popolazione
    if (row.votanti == null || row.non_votanti == null || row.non_aventi == null) {
      modeWarning.textContent = 'ND: dati insufficienti per stimare le tre componenti';
      modeWarning.style.display = 'block';
      // ripristina la modalità A
      modeSelect.value = 'A';
      filters.mode = 'A';
      updateCardAndChart();
      return;
    }
    data = [row.votanti, row.non_votanti, row.non_aventi];
    labels = ['Votanti stimati', 'Non votanti', 'Non aventi diritto'];
    colors = [
      getComputedStyle(document.documentElement).getPropertyValue('--modeC-color1'),
      getComputedStyle(document.documentElement).getPropertyValue('--modeC-color2'),
      getComputedStyle(document.documentElement).getPropertyValue('--modeC-color3')
    ];
    chartTitle.textContent = 'Modalità C: Votanti, non votanti e non aventi';
  }
  // Se esiste già un grafico, distruggerlo
  if (pieChart) pieChart.destroy();
  const ctx = document.getElementById('pie-chart').getContext('2d');
  pieChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors,
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label;
              const value = context.parsed;
              const total = context.chart._metasets[0].total;
              const percent = total ? (value / total * 100) : 0;
              return `${label}: ${formatItalianInt(value)} (${percent.toFixed(1).replace('.', ',')}%)`;
            }
          }
        }
      }
    }
  });
}

// Aggiorna la tabella con i dati filtrati e ordinati
function updateTable(filteredData) {
  // ordina
  const sorted = filteredData.slice().sort((a,b) => sortAsc ? a.anno - b.anno : b.anno - a.anno);
  tableBody.innerHTML = '';
  sorted.forEach(row => {
    const tr = document.createElement('tr');
    if (row.anno === selectedYear) tr.classList.add('selected');
    // Crea celle
    const cells = [
      row.anno,
      row.istituzione,
      row.popolazione != null ? formatItalianInt(row.popolazione) : 'ND',
      row.aventi != null ? formatItalianInt(row.aventi) : 'ND',
      row.perc_aventi != null ? formatItalianPercent(row.perc_aventi) : 'ND',
      row.affluenza != null ? formatItalianPercent(row.affluenza) : 'ND',
      row.sistema,
      row.legge,
      row.descrizione
    ];
    cells.forEach(text => {
      const td = document.createElement('td');
      td.textContent = text;
      tr.appendChild(td);
    });
    // Seleziona anno al click
    tr.addEventListener('click', () => {
      selectedYear = row.anno;
      yearSelect.value = selectedYear;
      yearSlider.value = selectedYear;
      updateAll();
      // scorre la riga selezionata al centro
      tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
    tableBody.appendChild(tr);
  });
}

// Aggiorna il log
function updateQualityLog() {
  // Rimuove i paragrafi esistenti (tranne il titolo)
  const existing = qualityContainer.querySelectorAll('p');
  existing.forEach(el => el.remove());
  qualityLog.forEach(msg => {
    const p = document.createElement('p');
    p.textContent = msg;
    qualityContainer.appendChild(p);
  });
}

// Aggiorna l’intera interfaccia
function updateAll() {
  const filtered = applyFilters();
  if (!filtered.find(r => r.anno === selectedYear)) {
    if (filtered.length > 0) {
      selectedYear = filtered[0].anno;
    }
  }
  updateYearControls(filtered);
  updateCardAndChart();
  updateTable(filtered);
}

// Inizializzazione
function init() {
  // Carica il log
  updateQualityLog();
  // Aggiorna tutto
  updateAll();
  // Event listeners
  yearSelect.addEventListener('change', () => {
    selectedYear = parseInt(yearSelect.value);
    yearSlider.value = selectedYear;
    updateCardAndChart();
    updateTable(applyFilters());
  });
  yearSlider.addEventListener('input', () => {
    selectedYear = parseInt(yearSlider.value);
    yearSelect.value = selectedYear;
    updateCardAndChart();
    updateTable(applyFilters());
  });
  istituzioneFilter.addEventListener('change', () => {
    filters.istituzione = istituzioneFilter.value;
    updateAll();
  });
  searchInput.addEventListener('input', () => {
    filters.search = searchInput.value.trim();
    updateAll();
  });
  modeSelect.addEventListener('change', () => {
    filters.mode = modeSelect.value;
    updateCardAndChart();
  });
  // Sorting per anno cliccando sull’intestazione
  const annoHeader = document.querySelector('th[data-sort="anno"]');
  annoHeader.addEventListener('click', () => {
    sortAsc = !sortAsc;
    updateTable(applyFilters());
    // aggiorna freccia visuale
    annoHeader.innerHTML = 'Anno ' + (sortAsc ? '▲' : '▼');
  });
  // inizializza intestazione con freccia
  annoHeader.innerHTML = 'Anno ▲';
}

// Avvia dopo il caricamento della pagina
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>